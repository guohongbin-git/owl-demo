<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OWLv2 Object Detection</title>
    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="file"],
        input[type="text"],
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .result-image img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
        .object-list {
            list-style: none;
            padding: 0;
        }
        .object-list li {
            background: #e9ecef;
            margin-bottom: 5px;
            padding: 10px;
            border-radius: 4px;
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .loading-spinner::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Cropper.js specific styles */
        .img-container {
            max-width: 100%;
            height: 400px; /* Fixed height for cropper container */
            background-color: #f7f7f7;
            overflow: hidden;
            display: none; /* Hidden by default */
        }
        .img-container img {
            max-width: 100%;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OWLv2 通用物体检测</h1>
        <form id="detectionForm">
            <div class="form-group">
                <label for="imageUpload">上传图像:</label>
                <input type="file" id="imageUpload" name="image" accept="image/*" required>
            </div>

            <div class="image-preview-section">
                <div class="img-container" id="imageContainer">
                    <img id="originalImage" src="" alt="Original Image">
                </div>
                <p id="roiInstruction" style="display: none; text-align: center; margin-top: 10px; color: #555;">在图片上拖动鼠标以框选感兴趣区域。</p>
            </div>

            <div id="detectionControls" style="display:none;">
                <div class="form-group">
                    <label for="queryTexts">查询文本 (逗号分隔，例如: a photo of a cat, a photo of a dog):</label>
                    <input type="text" id="queryTexts" name="query_texts" placeholder="输入查询文本" required>
                </div>
                <button type="submit">开始检测</button>
            </div>
        </form>

        <div class="loading-spinner" id="loadingSpinner"></div>
        <div class="error-message" id="errorMessage"></div>

        <div class="result-section" id="resultSection" style="display:none;">
            <h2>检测结果</h2>
            <div class="result-image">
                <img id="detectedImage" src="" alt="Detected Image" style="max-width: 100%; height: auto; display: none;">
            </div>
            <h3>检测到的物体:</h3>
            <ul class="object-list" id="objectList"></ul>
            <button id="saveImageBtn" style="display:none;">保存图像</button>
        </div>
    </div>

    <!-- Cropper.js JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
        alert('Script is running!'); // Added for debugging
        console.log('Script loaded and running!');

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded. Script started.');

            const imageUpload = document.getElementById('imageUpload');
            console.log('imageUpload element:', imageUpload);

            const originalImage = document.getElementById('originalImage');
            originalImage.onerror = function() {
                console.error('Original image failed to load. Check src:', this.src);
            };

            const imageContainer = document.getElementById('imageContainer');
            let cropper = null; // Cropper.js instance

            const detectionForm = document.getElementById('detectionForm');
            const errorMessage = document.getElementById('errorMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultSection = document.getElementById('resultSection');
            const detectedImage = document.getElementById('detectedImage');
            const objectList = document.getElementById('objectList');
            const saveImageBtn = document.getElementById('saveImageBtn');
            const detectionControls = document.getElementById('detectionControls');
            const roiInstruction = document.getElementById('roiInstruction');

            console.log('imageContainer element:', imageContainer);
            console.log('detectionForm element:', detectionForm);
            console.log('roiInstruction element:', roiInstruction);

            // Event listener for image file selection
            if (imageUpload) {
                console.log('Attempting to add change event listener to imageUpload.');
                imageUpload.addEventListener('change', function(event) {
                    console.log('Image upload change event triggered.');
                    const file = event.target.files[0];
                    if (file) {
                        console.log('File selected:', file.name, file.type, file.size, 'bytes');
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            console.log('FileReader loaded. Result length:', e.target.result.length);
                            originalImage.src = e.target.result;

                            // Destroy previous cropper instance if exists
                            if (cropper) {
                                cropper.destroy();
                                console.log('Previous Cropper instance destroyed.');
                            }

                            originalImage.onload = () => {
                                console.log('Original image loaded. src:', originalImage.src);
                                console.log('Original image complete:', originalImage.complete);
                                console.log('Original image natural dimensions:', originalImage.naturalWidth, originalImage.naturalHeight);

                                imageContainer.style.display = 'block'; // Show the container
                                detectedImage.style.display = 'none'; // Hide detected image
                                resultSection.style.display = 'none'; // Hide previous results

                                // Initialize Cropper.js
                                cropper = new Cropper(originalImage, {
                                    aspectRatio: NaN, // Free ratio
                                    viewMode: 1, // Restrict the crop box to not exceed the canvas
                                    autoCropArea: 0.8, // Initial crop area
                                    background: false, // Hide the grid background
                                    ready: function () {
                                        console.log('Cropper.js is ready.');
                                        detectionControls.style.display = 'block'; // Show detection controls
                                        roiInstruction.style.display = 'block'; // Show ROI instruction
                                    },
                                    crop: function(event) {
                                        // You can get crop data here if needed for real-time updates
                                        // console.log(event.detail.x);
                                        // console.log(event.detail.y);
                                        // console.log(event.detail.width);
                                        // console.log(event.detail.height);
                                    }
                                });
                            };
                        };
                        reader.onerror = function(e) {
                            console.error('FileReader error:', e.target.error);
                            errorMessage.textContent = '文件读取失败: ' + e.target.error.message;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        console.log('No file selected.');
                    }
                });
            } else {
                console.error('Error: imageUpload element not found!');
            }

            if (detectionForm) {
                detectionForm.addEventListener('submit', async function(event) {
                    event.preventDefault();

                    if (!cropper) {
                        errorMessage.textContent = '请先上传图片并选择区域。';
                        return;
                    }

                    const cropData = cropper.getData();
                    console.log('Cropper data:', cropData);

                    const formData = new FormData(detectionForm);
                    formData.append('roi_x', cropData.x);
                    formData.append('roi_y', cropData.y);
                    formData.append('roi_width', cropData.width);
                    formData.append('roi_height', cropData.height);

                    errorMessage.textContent = '';
                    resultSection.style.display = 'none';
                    loadingSpinner.style.display = 'block';
                    saveImageBtn.style.display = 'none';

                    try {
                        const response = await fetch('/detect', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (response.ok) {
                            detectedImage.src = 'data:image/png;base64,' + data.detected_image;
                            detectedImage.style.display = 'block'; // Show the detected image
                            imageContainer.style.display = 'none'; // Hide cropper container
                            roiInstruction.style.display = 'none'; // Hide ROI instruction
                            objectList.innerHTML = '';
                            data.objects.forEach(obj => {
                                const li = document.createElement('li');
                                li.textContent = `分数: ${obj.score}, 标签: ${obj.label}, 边界框: [${obj.box.join(', ')}]`;
                                objectList.appendChild(li);
                            });
                            resultSection.style.display = 'block';
                            saveImageBtn.style.display = 'block';

                            // 保存图像功能
                            saveImageBtn.onclick = function() {
                                const link = document.createElement('a');
                                link.href = detectedImage.src;
                                link.download = 'detected_image.png';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            };

                        } else {
                            errorMessage.textContent = '错误: ' + (data.error || '未知错误');
                        }
                    } catch (error) {
                        errorMessage.textContent = '请求失败: ' + error.message;
                    } finally {
                        loadingSpinner.style.display = 'none';
                    }
                });
            }
        });
    </script>